<!DOCTYPE html>
<html lang="en">
<!--
PPPP   AAAAA  Y   Y  TTTTTT  OOOO   N   N
P   P  A   A   Y Y     TT   O    O  NN  N
PPPP   AAAAA    Y      TT   O    O  N N N
P      A   A    Y      TT   O    O  N  NN
P      A   A    Y      TT    OOOO   N   N

Author: Michael Payton
Project: Rumination
Date: June 2025
Notes: Currently a draft ready for overview and further development.
Changes/Additions: unsure about the slider, must add questionnaires, must add consent form, likely 
                   needs to load parameters from .csv file. 
-->

<head>
    <meta charset="UTF-8">
    <title>Mining Task</title>
    <script src="https://unpkg.com/jspsych@6.3.0/jspsych.js"></script>
    <script src="https://unpkg.com/jspsych@6.3.0/plugins/jspsych-html-button-response.js"></script>
    <script src="https://unpkg.com/jspsych@6.3.0/plugins/jspsych-call-function.js"></script>
    <script src="https://unpkg.com/jspsych@6.3.0/plugins/jspsych-html-slider-response.js"></script>
    <link href="https://unpkg.com/jspsych@6.3.0/css/jspsych.css" rel="stylesheet">
    <style>
        #balance {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .jspsych-btn {
            font-size: 1em;
            padding: 10px 20px;
            margin: 0 5px;
        }
    </style>
</head>

<body>
    <div id="jspsych-target"></div>
    <script>
        // ==== PARAMETERS ====
        const N_BLOCKS = 3;
        const TRIALS_PER_BLOCK = 10;
        const STARTING_MONEY = 100;
        const NOISE = 0.65;   // Scanner noise, probability of a correct scan
        const SCAN_COST = 1;
        const REWARD = 50;   // reward if correct
        const PENALTY = 100; // penalty if incorrect

        // ==== STATE ====
        let currentMoney = STARTING_MONEY;
        let trueState;    // gold is in either at the "surface" or in the "core"
        let scanMsg;      // message given by scanner
        let lastDig = null;
        let lastCorrect = null;
        let scanCoreCount = 0;
        let scanSurfaceCount = 0;
        let scanCount = 0;      // total scans this trial

        // new asteroid, reset observation and counters
        function resetAsteroid() {
            trueState = (Math.random() < 0.5) ? 'surface' : 'core';
            scanMsg = null;
            scanCoreCount = 0;
            scanSurfaceCount = 0;
            scanCount = 0;
        }

        // ---- Trial: scan vs dig ----
        const scanOrDig = {
            type: 'html-button-response',
            stimulus: function () {
                return `
          <div id="balance">Gold: <strong>${currentMoney}</strong></div>
          <p>Previous observation: <strong>${scanMsg || 'None'}</strong></p>
          <p>Total number of Scans indicating Core: <strong>${scanCoreCount}</strong></p>
          <p>Total number of Scans indicating Surface: <strong>${scanSurfaceCount}</strong></p>
          <p>What do you do?</p>
        `;
            },
            choices: ['üîç Scan', '‚õè Dig in Core', 'üåê Dig at Surface'],
            on_finish: function (data) {
                const choice = parseInt(data.response);
                if (choice === 0) {
                    // -------- SCAN --------
                    currentMoney -= SCAN_COST;
                    // noisy observation
                    const obs = (Math.random() < NOISE)
                        ? trueState
                        : (trueState === 'surface' ? 'core' : 'surface');
                    scanMsg = (obs === 'surface')
                        ? 'Scanners suggest there is gold at the surface'
                        : 'Scanners suggest there is gold in the core';
                    // update counters
                    if (obs === 'surface') {
                        scanSurfaceCount++;
                    } else {
                        scanCoreCount++;
                    }
                    scanCount++;
                } else {
                    // -------- DIG --------
                    const dug = (choice === 1) ? 'core' : 'surface';
                    const correct = (dug === trueState);
                    // imperatively update balance
                    if (correct) {
                        currentMoney += REWARD;
                    } else {
                        currentMoney -= PENALTY;
                    }
                    data.correct = correct;
                    data.delta = correct ? REWARD : -PENALTY;
                    data.dug = dug;
                    data.scanCount = scanCount;  // record total scans this trial
                    scanMsg = null;
                }
            }
        };

        // loop until they choose to dig, allows infinite scanning
        const scanOrDigLoop = {
            timeline: [scanOrDig],
            loop_function: function (data) {
                const last = data.values().slice(-1)[0];
                return parseInt(last.response) === 0;  // keep looping if they scanned
            }
        };

        // ---- Feedback after each dig ----
        const digFeedback = {
            type: 'html-button-response',
            choices: [],    // no buttons
            stimulus: function () {
                // Grab all data, reverse it, and find the first trial where we actually dug
                const allData = jsPsych.data.get().values();
                const digData = allData
                    .slice()                      // copy
                    .reverse()                    // last trial first
                    .find(trial => trial.dug);    // only dig trials have `dug` defined

                return `
      <div id="balance">Gold: <strong>${currentMoney}</strong></div>
      ${digData.correct
                        ? `<p>You struck gold! (+${REWARD})</p>`
                        : `<p>Better luck next time! (‚àí${PENALTY})</p>`
                    }
    `;
            },
            trial_duration: 1500
        };

        // ---- Confidence slider after each dig ----
        const confidenceTrial = {
            type: 'html-slider-response',
            stimulus: '<p>How confident are you?</p>',
            labels: ['Positive gold is at surface', 'Positive gold is in core'],
            min: 0,
            max: 100,
            start: 50,
            step: 1,
            require_movement: true,
            data: { trial_part: 'confidence' },
            on_finish: function (data) {
                data.confidence = data.response;
            }
        };

        // ---- Build the timeline ----
        const timeline = [];

        // Instructions
        timeline.push({
            type: 'html-button-response',
            stimulus: `
        <h2>Mining Task (Draft instructions)</h2>
        <p>Welcome to the year 3000! We have sent mining drones all over the galaxy!</p>
        <p>Your job is to help us collect rare earth minerals from asteroids.</p>
        <p>Each asteroid a mining drone lands on has gold at the surface or in the core.</p>
        <p>But we don't know whether gold is in the surface or in the core until we scan!</p>
        <p>Unfortunately, our scanners are <strong>UNRELIABLE</strong></p>
        <p>You start with <strong>${STARTING_MONEY}</strong> gold.</p>
        <p>When you land on an asteroid, you have a options about what to do:</p>
        <p>üîç <strong>Scan</strong> (cost ${SCAN_COST}): you get noisy info about the location of the gold.</p>
        <p>‚õè <strong>Dig Core</strong> or üåê <strong>Dig Surface</strong>.</p>
        
        <p>If you get a correct dig: You win +${REWARD} gold. Incorrect: You lose ‚àí${PENALTY} gold.</p>
        <p>Scan as many times as you like to gain information about the gold location. Only dig when you're ready.</p>
        <p>Press <strong>Start</strong> to begin.</p>
      `,
            choices: ['Start']
        });

        // initialize first asteroid
        timeline.push({ type: 'call-function', func: resetAsteroid });

        // blocks
        for (let b = 0; b < N_BLOCKS; b++) {
            // block reminder
            timeline.push({
                type: 'html-button-response',
                stimulus: function () {
                    return `
            <h3>Block ${b + 1} of ${N_BLOCKS}</h3>
            <p>Current parameters:</p>
            <ul>
              <li>Scanner accuracy: ${Math.round(NOISE * 100)}%</li>
              <li>Scan cost: ${SCAN_COST} gold</li>
              <li>Reward: +${REWARD} gold</li>
              <li>Penalty: ‚àí${PENALTY} gold</li>
            </ul>
            <p>Your balance carries over.</p>
            <p>Press <strong>Continue</strong> when ready.</p>
          `;
                },
                choices: ['Continue']
            });

            // trials
            for (let t = 0; t < TRIALS_PER_BLOCK; t++) {
                timeline.push(scanOrDigLoop);
                timeline.push(confidenceTrial);
                timeline.push(digFeedback);
                timeline.push({ type: 'call-function', func: resetAsteroid });
            }
        }

        // final screen
        timeline.push({
            type: 'html-button-response',
            stimulus: `
        <h2>All done!</h2>
        <p>Your final balance: <strong>${currentMoney}</strong> gold.</p>
        <p>Thank you for playing.</p>
      `,
            choices: ['Finish']
        });

        // launch
        jsPsych.init({
            timeline: timeline,
            display_element: document.getElementById('jspsych-target')
        });

    </script>
</body>

</html>